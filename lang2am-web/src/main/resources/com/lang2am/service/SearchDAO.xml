<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lang2am.service.SearchDAO">

    <sql id="existsText">
    <if test="query != null and query != ''">
        and (
            exists (
                select 1
                from TB_TEXT b
                where b.CODE = a.CODE
                    and b.TEXT like concat('%', replace(replace(#{query},'%','\%'),'_','\_'),'%')
            )
            or
            a.CODE like concat('%', replace(replace(#{query},'%','\%'),'_','\_'),'%')
        )
    </if>
    </sql>

    <select id="listAllText" resultType="map">
	select a.CODE as code
		, max(case when a.LOCALE = 'ko_KR' then a.TEXT else null end) as textKo
		, max(case when a.LOCALE = 'en_US' then a.TEXT else null end) as textEn
        , max(case when a.LOCALE = 'en_US' then a.STATUS else null end) as statusEn
		, max(case when a.LOCALE = 'zh_CN' then a.TEXT else null end) as textZh
		, max(case when a.LOCALE = 'zh_CN' then a.STATUS else null end) as statusZh
		, (select count(1) from TB_REFERER b where b.code = a.CODE) as referenceCount
	from TB_TEXT a
	where 1=1
	<include refid="existsText"></include>
	group by a.CODE
	order by max(a.MODIFIED_TIME) desc, a.CODE
	limit #{limit}
    </select>

    <select id="count" resultType="int">
    select count(distinct CODE)
    from TB_TEXT a
    where 1=1
    <include refid="existsText"></include>
    </select>
</mapper>
